{{define "title"}}Station RPi Stop Buttons{{end}}

{{define "body"}}
<div class="container">
  <h1>Station RPi Stop Buttons</h1>
  <p>Provision a Raspberry Pi to read the station E-Stop/A-Stop buttons and report their state to the server.</p>

  <form id="rpiStopsForm" method="post" action="/setup/rpi/stops/run">
    <div class="well">
      <h4>Station RPi Target</h4>
      <div class="form-group">
        <label>Station ID</label>
        <select class="form-control" name="stationId">
          <option value="R1" {{if eq .RpiStops.StationId "R1"}} selected{{end}}>R1 (Red 1)</option>
          <option value="R2" {{if eq .RpiStops.StationId "R2"}} selected{{end}}>R2 (Red 2)</option>
          <option value="R3" {{if eq .RpiStops.StationId "R3"}} selected{{end}}>R3 (Red 3)</option>
          <option value="B1" {{if eq .RpiStops.StationId "B1"}} selected{{end}}>B1 (Blue 1)</option>
          <option value="B2" {{if eq .RpiStops.StationId "B2"}} selected{{end}}>B2 (Blue 2)</option>
          <option value="B3" {{if eq .RpiStops.StationId "B3"}} selected{{end}}>B3 (Blue 3)</option>
        </select>
      </div>
      <div class="form-group">
        <label>Target Host (Leave blank to scan subnet)</label>
        <input class="form-control" type="text" name="host" value="{{.RpiStops.Host}}" placeholder="10.0.100.31">
      </div>
      <div class="form-group">
        <label>Scan Subnet (CIDR)</label>
        <input class="form-control" type="text" name="scanSubnet" value="{{.RpiStops.ScanSubnet}}" placeholder="10.0.100.0/24">
      </div>

      <hr>

      <h4>Network Configuration</h4>
      <div class="form-group">
        <label>Static IP</label>
        <input class="form-control" type="text" name="staticHost" value="{{.RpiStops.StaticHost}}" placeholder="10.0.100.41" required>
      </div>
      <div class="form-group">
        <label>Subnet Mask</label>
        <input class="form-control" type="text" name="subnetMask" value="{{.RpiStops.SubnetMask}}" placeholder="255.255.255.0" required>
      </div>
      <div class="form-group">
        <label>Gateway</label>
        <input class="form-control" type="text" name="gateway" value="{{.RpiStops.Gateway}}" placeholder="10.0.100.2" required>
      </div>
      <div class="form-group">
        <label>DNS</label>
        <input class="form-control" type="text" name="dns" value="{{.RpiStops.DNS}}" placeholder="10.0.100.2" required>
      </div>

      <hr>

      <h4>SSH Authentication</h4>
      <div class="form-group">
        <label>Username</label>
        <input class="form-control" type="text" name="sshUser" value="{{.RpiStops.SSHUser}}" placeholder="admin">
      </div>
      <div class="form-group">
        <label>Password</label>
        <input class="form-control" type="text" name="sshPass" value="{{.RpiStops.SSHPass}}" placeholder="1234Five">
      </div>

      <hr>

      <h4>Server Endpoint</h4>
      <div class="form-group">
        <label>API Base URL</label>
        <input class="form-control" type="text" name="apiHost" value="{{.RpiStops.ApiHost}}" placeholder="http://10.0.100.5:8080" required>
        <p class="help-block">Include https:// or http:// and the port of the event server.</p>
      </div>
      <div class="form-group">
        <label>Station Secret</label>
        <input class="form-control" type="text" name="secret" value="{{.RpiStops.Secret}}" placeholder="Optional shared secret">
        <p class="help-block">Optional token required by the event server when processing stop reports.</p>
      </div>

      <button class="btn btn-primary" type="submit">Run Setup</button>
      <span id="statusBadge" class="label label-default" style="margin-left:10px;">{{.RpiStops.State}}</span>
    </div>
  </form>

  <h3>Status</h3>
  <pre id="logBox" style="max-height: 320px; overflow:auto; background:#111; color:#0f0; padding:8px;">{{.RpiStops.Log}}</pre>

  <h3 class="mt-4">Station Stop Boxes Status</h3>
  <div class="table-responsive">
    <table class="table table-striped table-condensed" id="stationStatusTable">
      <thead>
        <tr>
          <th>Station</th>
          <th>Online</th>
          <th>E-Stop</th>
          <th>A-Stop</th>
        </tr>
      </thead>
      <tbody>
        {{range .StationStatus}}
        <tr data-station="{{.Station}}">
          <td>{{.Station}}</td>
          <td class="station-online" data-online="{{.Online}}">{{if .Online}}Online{{else}}Offline{{end}}</td>
          <td class="station-estop">{{if .RemoteEStop}}Active{{else}}&mdash;{{end}}</td>
          <td class="station-astop">{{if .RemoteAStop}}Active{{else}}&mdash;{{end}}</td>
        </tr>
        {{end}}
      </tbody>
    </table>
  </div>
</div>
{{end}}

{{define "script"}}
<script>
(function(){
  function poll(){
    fetch('/setup/rpi/stops/status')
      .then(r => r.json())
      .then(js => {
        document.getElementById('statusBadge').textContent = js.state || 'Idle';
        const box = document.getElementById('logBox');
        box.textContent = js.log || '';
        box.scrollTop = box.scrollHeight;
        updateStationStatusTable(js.stationStatus || []);
        setTimeout(poll, 1000);
      })
      .catch(() => setTimeout(poll, 1500));
  }

  function updateStationStatusTable(statuses) {
    const tbody = document.querySelector('#stationStatusTable tbody');
    if (!tbody) {
      return;
    }
    statuses.forEach(status => {
      let row = tbody.querySelector(`tr[data-station="${status.Station}"]`);
      if (!row) {
        row = document.createElement('tr');
        row.setAttribute('data-station', status.Station);
        row.innerHTML = `
          <td>${status.Station}</td>
          <td class="station-online"></td>
          <td class="station-estop"></td>
          <td class="station-astop"></td>
          <td class="station-last"></td>
        `;
        tbody.appendChild(row);
      }
      row.querySelector('.station-online').textContent = status.Online ? 'Online' : 'Offline';
      row.querySelector('.station-estop').textContent = status.RemoteEStop ? 'Active' : '—';
      row.querySelector('.station-astop').textContent = status.RemoteAStop ? 'Active' : '—';
    });
  }
  poll();
})();
</script>
{{end}}
