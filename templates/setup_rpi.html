{{define "title"}}Raspberry Pi Setup{{end}}

{{define "body"}}
<div class="container">
  <h1>Raspberry Pi Setup</h1>
  <p>Configure a Raspberry Pi Display to launch with a set display ID and set a static IP.</p>

  <form id="rpiForm" method="post" action="/setup/rpi/run">
    <div class="well">
      <h4>Raspberry Pi Target</h4>
      <div class="form-group">
        <label>Target Host (Leave blank to scan subnet for hosts if current IP is unknown)</label>
        <input class="form-control" type="text" name="host" value="{{.Rpi.Host}}" placeholder="10.0.100.31">
      </div>

      <div class="form-group">
        <label>Scan Subnet (Subnet to scan if Target Host IP is blank (CIDR))</label>
        <input class="form-control" type="text" name="scanSubnet" value="{{.Rpi.ScanSubnet}}" placeholder="10.0.100.0/24">
      </div>

      <hr>

      <h4>Display ID and Static IP</h4>
      <div class="form-group">
        <label>Display ID</label>
        <input class="form-control" type="text" name="displayId" value="{{.Rpi.DisplayID}}" required>
        <p class="help-block">Will open: <code>http://10.0.100.5:8080/display?displayId=&lt;value&gt;</code></p>
      </div>
      <div class="form-group">
        <label>Static IP</label>
        <input class="form-control" type="text" name="staticHost" value="{{.Rpi.StaticHost}}" placeholder="10.0.100.41" required>
      </div>
      <div class="form-group">
        <label>Subnet Mask (CIDR or dotted)</label>
        <input class="form-control" type="text" name="subnetMask" value="{{.Rpi.SubnetMask}}" placeholder="255.255.255.0" required>
      </div>
      <div class="form-group">
        <label>Gateway</label>
        <input class="form-control" type="text" name="gateway" value="{{.Rpi.Gateway}}" placeholder="10.0.100.2" required>
      </div>
      <div class="form-group">
        <label>DNS</label>
        <input class="form-control" type="text" name="dns" value="{{.Rpi.DNS}}" placeholder="10.0.100.2" required>
      </div>

      <hr>

      <h4>SSH Authentication</h4>
      <div class="form-group">
        <label>Username</label>
        <input class="form-control" type="text" name="sshUser" value="{{.Rpi.SSHUser}}" placeholder="admin">
      </div>
      <div class="form-group">
        <label>Password</label>
        <input class="form-control" type="text" name="sshPass" value="{{.Rpi.SSHPass}}" placeholder="1234Five">
      </div>

      <button class="btn btn-primary" type="submit">Run Setup</button>
      <span id="statusBadge" class="label label-default" style="margin-left:10px;">{{.Rpi.State}}</span>
    </div>
  </form>

  <h3>Status</h3>
  <pre id="logBox" style="max-height: 320px; overflow:auto; background:#111; color:#0f0; padding:8px;">{{.Rpi.Log}}</pre>
</div>
{{end}}

{{define "script"}}
<script>
(function(){
  function poll(){
    fetch('/setup/rpi/status')
      .then(r => r.json())
      .then(js => {
        document.getElementById('statusBadge').textContent = js.state || 'Idle';
        const box = document.getElementById('logBox');
        box.textContent = js.log || '';
        box.scrollTop = box.scrollHeight;
        setTimeout(poll, 1000);
      })
      .catch(() => setTimeout(poll, 1500));
  }
  poll();
})();
</script>
{{end}}
